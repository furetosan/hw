<<<<<<< HEAD
var uglify = require('uglify-js')

=======
var scope = require('lexical-scope')
>>>>>>> ed0835dbdefb70eb2dc3fb6233be1241914cfcd5

module.exports = addWith

function addWith(obj, src, exclude) {
  exclude = exclude || []
<<<<<<< HEAD
  exclude = exclude.concat(detect(obj))
  var vars = detect('(function () {' + src + '}())')//allows the `return` keyword
=======
  var objScope = scope(obj)
  exclude = exclude.concat(objScope.globals.implicit).concat(objScope.globals.exported)
  var s = scope('(function () {' + src + '}())')//allows the `return` keyword
  var vars = s.globals.implicit
>>>>>>> ed0835dbdefb70eb2dc3fb6233be1241914cfcd5
    .filter(function (v) {
      return !(v in global) && exclude.indexOf(v) === -1
    })

  if (vars.length === 0) return src

  var declareLocal = ''
  var local = 'locals'
  if (/^[a-zA-Z0-9$_]+$/.test(obj)) {
    local = obj
  } else {
<<<<<<< HEAD
    while (vars.indexOf(local) != -1 || exclude.indexOf(local) != -1) {
=======
    while (s.globals.implicit.indexOf(local) != -1 || s.globals.exported.indexOf(local) != -1 || exclude.indexOf(local) != -1  || obj.indexOf(local) != -1) {
>>>>>>> ed0835dbdefb70eb2dc3fb6233be1241914cfcd5
      local += '_'
    }
    declareLocal = local + ' = (' + obj + '),'
  }
  return 'var ' + declareLocal + vars
    .map(function (v) {
      return v + ' = ' + local + '.' + v
    }).join(',') + ';' + src
<<<<<<< HEAD
}

function detect(src) {
    var ast = uglify.parse(src.toString())
    ast.figure_out_scope()
    var globals = ast.globals
        .map(function (node, name) {
            return name
        })
    return globals;
=======
>>>>>>> ed0835dbdefb70eb2dc3fb6233be1241914cfcd5
}